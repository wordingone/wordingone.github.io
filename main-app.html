<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prada: Remaking | Architectural Navigation System</title>
    <!-- Disable favicon to prevent 404 errors -->
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Video Overlay Styles */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: none;
            z-index: 10000;
        }

        .video-overlay.active {
            display: block;
        }

        .intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Skip Button */
        .skip-button {
            position: fixed;
            top: 40px;
            right: 40px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10001;
        }

        /* Sound Button - INVISIBLE */
        .sound-button {
            position: fixed;
            top: 40px;
            right: 100px;
            width: 50px;
            height: 50px;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10001;
            opacity: 0; /* Completely invisible */
        }

        .sound-button.visible {
            display: flex;
        }

        .sound-button:hover {
            /* No hover effect since it's invisible */
        }

        .sound-button.muted .sound-icon::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 24px;
            background: #fff;
            transform: rotate(-45deg);
            left: 11px;
            top: -2px;
        }

        /* Sound icon */
        .sound-icon {
            position: relative;
            width: 24px;
            height: 24px;
        }

        .sound-icon::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #fff;
            left: 2px;
            top: 8px;
        }

        .sound-icon span {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 10px;
            border-color: transparent transparent transparent #fff;
            left: 10px;
            top: 4px;
        }

        .skip-button.visible {
            display: flex;
        }

        .skip-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Double arrow skip icon */
        .skip-icon {
            position: relative;
            width: 20px;
            height: 20px;
        }

        .skip-icon::before,
        .skip-icon::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            border-color: transparent;
        }

        .skip-icon::before {
            border-left-width: 10px;
            border-right-width: 0;
            border-top-width: 6px;
            border-bottom-width: 6px;
            border-left-color: #fff;
            top: 4px;
            left: 2px;
        }

        .skip-icon::after {
            border-left-width: 10px;
            border-right-width: 0;
            border-top-width: 6px;
            border-bottom-width: 6px;
            border-left-color: #fff;
            top: 4px;
            left: 10px;
        }

        /* Loading status for video overlay */
        .video-loading-status {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            letter-spacing: 1px;
            display: none;
            z-index: 10002;
        }

        .video-loading-status.visible {
            display: block;
        }

        @media (max-width: 768px) {
            .skip-button {
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Video Overlay - Shows on arrival from index -->
    <div class="video-overlay" id="videoOverlay">
        <video class="intro-video" id="introVideo" playsinline preload="auto">
            <source src="./videos/complete animation.mp4" type="video/mp4">
        </video>
        <div class="sound-button muted" id="soundButton">
            <div class="sound-icon"><span></span></div>
        </div>
        <div class="skip-button" id="skipButton">
            <div class="skip-icon"></div>
        </div>
        <div class="video-loading-status" id="videoLoadingStatus">Loading LiDAR and models...</div>
    </div>

    <!-- Main Layout Container -->
    <div id="app-container">
        <!-- Left Panel: 3D Model Viewer (1/3 width) -->
        <div id="model-panel">
            <!-- Brand Header -->
            <div class="brand-header">
                <div class="brand-logo">PRADA: (RE)MAKING</div>
                <div class="brand-subtitle">Architectural Navigation System</div>
            </div>
            
            <canvas id="canvas"></canvas>
            
            <!-- Model Info Overlay -->
            <div id="model-info" class="glass">
                <h3>3D Navigation Model</h3>
                <p>5-Floor Architectural System</p>
                <p>Mouse: rotate | Wheel: zoom</p>
                <p>2,673 instanced components</p>
            </div>
        </div>
        
        <!-- Right Panel: LiDAR Interface (2/3 width) -->
        <div id="main-panel">
            <!-- LiDAR Control Bar -->
            <div class="lidar-controls">
                <button id="btnHighlight" type="button" class="control-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <circle cx="8" cy="8" r="3" fill="currentColor"/>
                    </svg>
                    <span class="btn-text">Highlight</span>
                </button>
                <button id="btnZoomExtents" type="button" class="control-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8C14 11.3137 11.3137 14 8 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M6 12L2 12L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="btn-text">Reset View</span>
                </button>
            </div>
            
            <!-- LiDAR Board Interface with proper aspect ratio container -->
            <div id="lidar-board">
                <!-- Aspect ratio container that maintains proportions -->
                <div class="lidar-container">
                    <!-- Background image -->
                    <div class="lidar-background"></div>
                    
                    <!-- Interactive hotspots - positioned relative to container -->
                    <!-- Region 1: Central workspace area (rotated 1.2 degrees clockwise) -->
                    <div class="hotspot" data-area="index" data-coords="516,448,154,37" data-rotation="4.0">
                        <span class="hotspot-label">index</span>
                    </div>
                    
                    <!-- Region 2: Upper central area (shifted down 2px) -->
                    <div class="hotspot" data-area="mirror" data-coords="818,459,104,44" data-rotation="2.9">
                        <span class="hotspot-label">mirror</span>
                    </div>
                    
                    <!-- Region 3: Right exhibition area (rotated rect) -->
                    <div class="hotspot" data-area="exhibition-right" data-coords="1285,589,153,131" data-rotation="0.8">
                        <span class="hotspot-label">exhibition-right</span>
                    </div>
                    
                    <!-- Region 4: Archive inside area (moved 2px right) -->
                    <div class="hotspot" data-area="archive_inside" data-coords="354,440,58,44" data-rotation="4.2">
                        <span class="hotspot-label">archive_inside</span>
                    </div>
                    
                    <!-- Region 5: Archive center (large vertical rect) -->
                    <div class="hotspot" data-area="archive_2" data-coords="831,574,113,84" data-rotation="0">
                        <span class="hotspot-label">archive_2</span>
                    </div>
                    
                    <!-- Region 6: Red dye area (shifted right 1px more) -->
                    <div class="hotspot" data-area="red_dye" data-coords="1345,346,101,112" data-rotation="0.4">
                        <span class="hotspot-label">red_dye</span>
                    </div>
                    
                    <!-- Region 7: Documentation area (shifted right 5px) -->
                    <div class="hotspot" data-area="circulation_1" data-coords="1220,216,109,163" data-rotation="0.5">
                        <span class="hotspot-label">circulation_1</span>
                    </div>
                    
                    <!-- Region 8: Digital workspace (horizontal rect) -->
                    <div class="hotspot" data-area="insula" data-coords="948,522,136,109" data-rotation="0.3">
                        <span class="hotspot-label">insula</span>
                    </div>
                    
                    <!-- Region 9: Studio corner (moved 2px left) -->
                    <div class="hotspot" data-area="altar" data-coords="1426,455,62,42" data-rotation="-2.1">
                        <span class="hotspot-label">altar</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Architectural Models...</p>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js",
            "three/examples/jsm/loaders/DRACOLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/DRACOLoader.js",
            "three/examples/jsm/controls/OrbitControls": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js"
        }
    }
    </script>
    
    <script>
        // Handle video overlay on arrival from index
        (function() {
            const videoOverlay = document.getElementById('videoOverlay');
            const introVideo = document.getElementById('introVideo');
            const skipButton = document.getElementById('skipButton');
            const soundButton = document.getElementById('soundButton');
            const videoLoadingStatus = document.getElementById('videoLoadingStatus');
            
            // Check if we should play the intro video
            const shouldPlayVideo = sessionStorage.getItem('playIntroVideo');
            
            if (shouldPlayVideo === 'true') {
                // Clear the flag
                sessionStorage.removeItem('playIntroVideo');
                
                // Show video overlay
                videoOverlay.classList.add('active');
                videoLoadingStatus.classList.add('visible');
                
                // Start loading resources
                let resourcesLoaded = false;
                let videoEnded = false;
                let lidarImageLoaded = false;
                
                // Check if LiDAR board image has loaded
                function checkLidarImageLoad() {
                    const lidarBackground = document.querySelector('.lidar-background');
                    if (lidarBackground) {
                        // Create a test image to check if the background image is loaded
                        const testImg = new Image();
                        testImg.onload = function() {
                            console.log('LiDAR board image fully loaded');
                            lidarImageLoaded = true;
                            checkResourcesComplete();
                        };
                        testImg.onerror = function() {
                            console.error('LiDAR board image failed to load');
                            lidarImageLoaded = true; // Still allow skip even if image fails
                            checkResourcesComplete();
                        };
                        // Extract the URL from the CSS background-image
                        testImg.src = './lidar_00.png';
                    }
                }
                
                // Check if all resources are ready
                function checkResourcesComplete() {
                    if (resourcesLoaded && lidarImageLoaded) {
                        console.log('All resources loaded - showing skip button');
                        videoLoadingStatus.textContent = 'Ready';
                        skipButton.classList.add('visible');
                        
                        // If video already ended, close overlay
                        if (videoEnded) {
                            setTimeout(closeVideoOverlay, 500);
                        }
                    }
                }
                
                // Simulate resource loading
                function startLoadingResources() {
                    // Start checking for LiDAR image
                    checkLidarImageLoad();
                    
                    let progress = 0;
                    const loadingMessages = [
                        'Loading LiDAR interface...',
                        'Loading 3D models...',
                        'Initializing environment...',
                        'Preparing experience...'
                    ];
                    
                    let messageIndex = 0;
                    const loadingInterval = setInterval(() => {
                        progress += 20; // Slower to give LiDAR time to load
                        messageIndex = Math.min(Math.floor(progress / 25), loadingMessages.length - 1);
                        videoLoadingStatus.textContent = loadingMessages[messageIndex];
                        
                        if (progress >= 100) {
                            clearInterval(loadingInterval);
                            resourcesLoaded = true;
                            checkResourcesComplete();
                        }
                    }, 1200); // ~6 seconds total to allow for LiDAR image
                }
                
                // Close video overlay
                function closeVideoOverlay() {
                    videoOverlay.classList.remove('active');
                    skipButton.classList.remove('visible');
                    soundButton.classList.remove('visible');
                    videoLoadingStatus.classList.remove('visible');
                    introVideo.pause();
                    introVideo.currentTime = 0;
                }
                
                // Check if we came from user interaction (clicking logo)
                // This might allow autoplay with sound!
                const cameFromUserAction = document.referrer.includes('index.html') || 
                                          document.referrer.endsWith('wordingone.github.io/');
                
                let audioAllowed = false;
                
                // If user clicked to get here, try with sound first
                if (cameFromUserAction) {
                    console.log('User navigated here via click, attempting autoplay with sound...');
                    introVideo.muted = false;
                    introVideo.volume = 0.7;
                } else {
                    // Direct navigation - start muted
                    console.log('Direct navigation detected, starting muted');
                    introVideo.muted = true;
                }
                
                const playPromise = introVideo.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        if (!introVideo.muted) {
                            console.log('✓ Video playing WITH SOUND (user interaction carried over)');
                            audioAllowed = true;
                            soundButton.classList.remove('muted');
                        } else {
                            console.log('Video playing muted');
                        }
                        soundButton.classList.add('visible');
                        startLoadingResources();
                    }).catch(error => {
                        console.log('Autoplay failed, trying muted fallback:', error.message);
                        // Fallback: mute and try again
                        introVideo.muted = true;
                        soundButton.classList.add('visible');
                        introVideo.play().then(() => {
                            console.log('Video playing muted (fallback)');
                            startLoadingResources();
                        }).catch(err => {
                            console.error('Video play completely failed:', err);
                            startLoadingResources();
                        });
                    });
                } else {
                    introVideo.play();
                    startLoadingResources();
                }
                
                // Handle video end
                introVideo.addEventListener('ended', function() {
                    videoEnded = true;
                    if (resourcesLoaded) {
                        setTimeout(closeVideoOverlay, 500);
                    }
                });
                
                // Handle sound button
                soundButton.addEventListener('click', function() {
                    if (introVideo.muted) {
                        introVideo.muted = false;
                        introVideo.volume = 0.7;
                        soundButton.classList.remove('muted');
                        console.log('Video unmuted');
                    } else {
                        introVideo.muted = true;
                        soundButton.classList.add('muted');
                        console.log('Video muted');
                    }
                });
                
                // Handle skip button
                skipButton.addEventListener('click', function() {
                    if (resourcesLoaded) {
                        closeVideoOverlay();
                    }
                });
                
                // Handle escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && videoOverlay.classList.contains('active') && resourcesLoaded) {
                        closeVideoOverlay();
                    }
                });
            }
        })();
    </script>
    
    <script type="module" src="main.js"></script>
</body>
</html>
